<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operatørrunde</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #f9fafb; }
        button { min-height: 44px; }
        input[type="checkbox"] { width: 1.2rem; height: 1.2rem; }
        .loading {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const Button = ({ children, onClick, className }) => 
            React.createElement('button', {
                onClick,
                className: `px-4 py-2 rounded text-white font-medium ${className}`
            }, children);

        const Checkbox = ({ id, checked, onChange, label }) =>
            React.createElement('div', { className: 'flex items-start space-x-3 py-1' },
                React.createElement('input', {
                    type: 'checkbox',
                    id,
                    checked,
                    onChange: (e) => onChange(e.target.checked),
                    className: 'mt-1'
                }),
                React.createElement('label', {
                    htmlFor: id,
                    className: checked ? 'line-through text-gray-500' : 'text-gray-900'
                }, label)
            );

        const parseCSVData = (csvData) => {
            const tasks = {};
            csvData.forEach(row => {
                if (!tasks[row.area]) {
                    tasks[row.area] = {};
                }
                if (!tasks[row.area][row.category]) {
                    tasks[row.area][row.category] = [];
                }
                tasks[row.area][row.category].push({
                    id: parseInt(row.taskId),
                    description: row.description,
                    completed: false
                });
            });
            return tasks;
        };

        const App = () => {
            const [tasks, setTasks] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [currentScreen, setCurrentScreen] = React.useState('welcome');
            const [selectedArea, setSelectedArea] = React.useState(null);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                // Først prøv å hente fra localStorage
                const savedTasks = localStorage.getItem('osebergTasks');
                const lastUpdated = localStorage.getItem('osebergTasksUpdated');
                const now = new Date().getTime();
                
                // Hvis det er data i localStorage og det er mindre enn 24 timer siden sist oppdatering
                if (savedTasks && lastUpdated && (now - parseInt(lastUpdated)) < 24 * 60 * 60 * 1000) {
                    setTasks(JSON.parse(savedTasks));
                    setLoading(false);
                } else {
                    // Hvis ikke, last fra CSV
                    fetch('tasks.csv')
                        .then(response => response.text())
                        .then(csv => {
                            const results = Papa.parse(csv, {
                                header: true,
                                skipEmptyLines: true
                            });
                            const parsedTasks = parseCSVData(results.data);
                            
                            // Behold completed status fra localStorage hvis det finnes
                            if (savedTasks) {
                                const oldTasks = JSON.parse(savedTasks);
                                Object.keys(parsedTasks).forEach(area => {
                                    Object.keys(parsedTasks[area]).forEach(category => {
                                        parsedTasks[area][category].forEach(task => {
                                            const oldTask = oldTasks[area]?.[category]?.find(t => t.id === task.id);
                                            if (oldTask) {
                                                task.completed = oldTask.completed;
                                            }
                                        });
                                    });
                                });
                            }
                            
                            setTasks(parsedTasks);
                            localStorage.setItem('osebergTasks', JSON.stringify(parsedTasks));
                            localStorage.setItem('osebergTasksUpdated', now.toString());
                            setLoading(false);
                        })
                        .catch(err => {
                            setError('Kunne ikke laste oppgaver: ' + err.message);
                            setLoading(false);
                        });
                }
            }, []);

            const areasOppe = ['W21', 'P21/Mezz', 'C22', 'P22', 'P23', 'Boligkvarter'];
            const areasNede = ['P12', 'P11', 'W13', 'W12', 'W11', 'Z10', 'C12', 'C11'];

            const selectArea = (area) => {
                setSelectedArea(area);
                setCurrentScreen('tasks');
            };

            const toggleTask = (area, category, id) => {
                const newTasks = {
                    ...tasks,
                    [area]: {
                        ...tasks[area],
                        [category]: tasks[area][category].map(task =>
                            task.id === id ? { ...task, completed: !task.completed } : task
                        )
                    }
                };
                setTasks(newTasks);
                localStorage.setItem('osebergTasks', JSON.stringify(newTasks));
            };

            const resetTasks = (area) => {
                const newTasks = {
                    ...tasks,
                    [area]: Object.fromEntries(
                        Object.entries(tasks[area]).map(([category, categoryTasks]) => [
                            category,
                            categoryTasks.map(task => ({ ...task, completed: false }))
                        ])
                    )
                };
                setTasks(newTasks);
                localStorage.setItem('osebergTasks', JSON.stringify(newTasks));
            };

            const resetAllTasks = () => {
                const newTasks = Object.fromEntries(
                    Object.entries(tasks).map(([area, areaTasks]) => [
                        area,
                        Object.fromEntries(
                            Object.entries(areaTasks).map(([category, categoryTasks]) => [
                                category,
                                categoryTasks.map(task => ({ ...task, completed: false }))
                            ])
                        )
                    ])
                );
                setTasks(newTasks);
                localStorage.setItem('osebergTasks', JSON.stringify(newTasks));
            };

            if (loading) {
                return React.createElement('div', { 
                    className: 'flex items-center justify-center min-h-screen' 
                }, 
                    React.createElement('div', { className: 'loading' })
                );
            }

            if (error) {
                return React.createElement('div', {
                    className: 'p-4 max-w-md mx-auto'
                },
                    React.createElement('div', {
                        className: 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4'
                    }, error)
                );
            }

            if (currentScreen === 'welcome') {
                return React.createElement('div', { className: 'p-4 max-w-md mx-auto' },
                    React.createElement('div', { className: 'space-y-6' },
                        React.createElement('h1', { className: 'text-2xl font-bold' }, 'Oseberg Sør'),
                        React.createElement('div', { className: 'p-4 bg-blue-100 rounded-lg' },
                            React.createElement('h2', { 
                                className: 'text-xl font-semibold mb-2 text-blue-800' 
                            }, 'Operatørrunde Oppe'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                ...areasOppe.map(area =>
                                    React.createElement(Button, {
                                        key: area,
                                        onClick: () => selectArea(area),
                                        className: 'bg-blue-600 hover:bg-blue-700'
                                    }, area)
                                )
                            )
                        ),
                        React.createElement('div', { className: 'p-4 bg-green-100 rounded-lg' },
                            React.createElement('h2', { 
                                className: 'text-xl font-semibold mb-2 text-green-800' 
                            }, 'Operatørrunde Nede'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                ...areasNede.map(area =>
                                    React.createElement(Button, {
                                        key: area,
                                        onClick: () => selectArea(area),
                                        className: 'bg-green-600 hover:bg-green-700'
                                    }, area)
                                )
                            )
                        ),
                        React.createElement(Button, {
                            onClick: resetAllTasks,
                            className: 'w-full bg-red-600 hover:bg-red-700'
                        }, 'Tilbakestill alle oppgaver')
                    )
                );
            }

            return React.createElement('div', { className: 'p-4 max-w-md mx-auto' },
                React.createElement('div', { className: 'space-y-4' },
                    React.createElement('div', { className: 'flex items-center justify-between' },
                        React.createElement(Button, {
                            onClick: () => setCurrentScreen('welcome'),
                            className: 'bg-gray-500 hover:bg-gray-600'
                        }, 'Tilbake'),
                        React.createElement('h2', { 
                            className: 'text-xl font-semibold' 
                        }, `Oppgaver for ${selectedArea}`)
                    ),
                    tasks[selectedArea] && Object.entries(tasks[selectedArea]).map(([category, categoryTasks]) =>
                        React.createElement('div', { 
                            key: category, 
                            className: 'bg-white rounded-lg p-4 shadow' 
                        },
                            React.createElement('h3', { 
                                className: 'text-lg font-semibold mb-2' 
                            }, category),
                            categoryTasks.map(task =>
                                React.createElement(Checkbox, {
                                    key: task.id,
                                    id: `${selectedArea}-${category}-${task.id}`,
                                    checked: task.completed,
                                    onChange: () => toggleTask(selectedArea, category, task.id),
                                    label: task.description
                                    ))
                        )
                    ),
                    React.createElement(Button, {
                        onClick: () => resetTasks(selectedArea),
                        className: 'w-full bg-yellow-600 hover:bg-yellow-700 mt-4'
                    }, `Tilbakestill oppgaver for ${selectedArea}`)
                )
            );
        };

        // Start appen
        ReactDOM.render(
            React.createElement(App),
            document.getElementById('root')
        );
    </script>
</body>
</html>
